<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>書籍預購表單</title>
    <!-- 引入 Tailwind CSS 以便快速美化頁面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* 使用 Inter 字體 */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 為顯示/隱藏的區塊加上平滑過渡效果 */
        #delivery-details {
            transition: all 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        #delivery-details.visible {
            max-height: 500px; /* 一個足夠大的高度 */
            opacity: 1;
            margin-top: 0.75rem; /* 顯示時增加一些間距 */
        }
         /* 簡易的訊息提示框 */
        #toast-message {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            transition: bottom 0.5s ease-in-out;
            z-index: 100;
        }
        #toast-message.show {
            bottom: 20px;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-lg mx-auto bg-white rounded-2xl shadow-lg p-6 m-4">
        
        <!-- 表單標題 -->
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">書籍預購表單</h1>
            <p class="text-gray-500 mt-1">請填寫以下資訊完成預購</p>
        </div>

        <!-- 新增：預購品項 -->
        <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-lg font-bold text-gray-800 mb-3 text-center">預購內容</h2>
            <div class="flex flex-col md:flex-row items-center gap-4">
                <div class="w-full md:w-1/3 flex-shrink-0">
                    <img src="https://i.postimg.cc/hG9DSmPP/532933219-2598075583868024-1427644122180406169-n.jpg" alt="《薊馬：纓翅類群的小昆蟲》書籍封面" class="rounded-md shadow-md w-full h-auto object-cover" onerror="this.onerror=null;this.src='https://placehold.co/300x420/E2E8F0/4A5568?text=%E6%9B%B8%E7%B1%8D%E5%B0%81%E9%9D%A2';">
                </div>
                <div class="w-full md:w-2/3">
                    <ul class="space-y-2 text-base text-gray-700">
                        <li class="flex items-start">
                            <svg class="w-5 h-5 text-indigo-500 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            <span>《薊馬：纓翅類群的小昆蟲》新書一本</span>
                        </li>
                        <li class="flex items-start">
                            <svg class="w-5 h-5 text-indigo-500 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            <span>台灣昆蟲學會紀念膠帶一卷</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <form id="preorderForm">
            <!-- 新增：訂購人基本資料 -->
            <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="customer-name" class="block text-base font-medium text-gray-700 mb-1.5">訂購人姓名</label>
                    <input type="text" id="customer-name" name="customer_name" required class="w-full px-3 py-2 text-base bg-gray-50 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500 transition-colors">
                </div>
                <div>
                    <label for="customer-email" class="block text-base font-medium text-gray-700 mb-1.5">Email</label>
                    <input type="email" id="customer-email" name="customer_email" required class="w-full px-3 py-2 text-base bg-gray-50 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500 transition-colors">
                </div>
            </div>

            <!-- 步驟一：訂購數量 -->
            <div class="mb-4">
                <label for="quantity" class="block text-base font-medium text-gray-700 mb-1.5">1. 訂購數量</label>
                <div class="flex items-center border-2 border-gray-200 rounded-lg p-1.5 focus-within:border-indigo-500 transition-colors">
                    <span class="text-gray-500 mr-2 pl-1 text-sm">數量：</span>
                    <input type="number" id="quantity" name="quantity" value="1" min="1" class="w-full text-base appearance-none bg-transparent border-none focus:outline-none focus:ring-0">
                    <span class="text-gray-600 font-medium mr-2 text-sm">本</span>
                </div>
                <p class="text-xs text-gray-500 mt-1.5">單價：新台幣 960 元 / 本</p>
            </div>

            <!-- 步驟二：取貨方式 -->
            <div class="mb-4">
                <label class="block text-base font-medium text-gray-700 mb-1.5">2. 取貨方式</label>
                <div class="space-y-2">
                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50 transition-all">
                        <input type="radio" name="delivery" value="pickup" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500" checked>
                        <span class="ml-3 text-sm font-medium text-gray-800">現場親取</span>
                    </label>
                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50 transition-all">
                        <input type="radio" name="delivery" value="delivery" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-3 text-sm font-medium text-gray-800">宅配到府 <span class="text-xs font-normal text-gray-500">(+80元 運費)</span></span>
                    </label>
                </div>
                <!-- 宅配資訊 (預設隱藏) -->
                <div id="delivery-details" class="space-y-3">
                    <div class="mt-3">
                        <label for="recipient-name" class="block text-sm font-medium text-gray-700">收件人姓名</label>
                        <input type="text" id="recipient-name" name="recipient_name" class="mt-1 block w-full px-3 py-1.5 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="recipient-phone" class="block text-sm font-medium text-gray-700">收件人手機號碼</label>
                        <input type="tel" id="recipient-phone" name="recipient_phone" class="mt-1 block w-full px-3 py-1.5 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="recipient-address" class="block text-sm font-medium text-gray-700">收件地址</label>
                        <div class="flex items-center mt-1 space-x-2">
                            <input type="text" id="postal-code" name="postal_code" placeholder="郵遞區號" class="block w-24 px-3 py-1.5 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <input type="text" id="recipient-address" name="recipient_address" placeholder="詳細地址" class="block w-full px-3 py-1.5 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 pt-1">※ 備註：預計 2025 年 11 月底前出貨。</p>
                </div>
            </div>

            <!-- 步驟三：繳費方式 -->
            <div class="mb-5">
                <label class="block text-base font-medium text-gray-700 mb-1.5">3. 繳費方式</label>
                <div class="space-y-2">
                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50 transition-all">
                        <input type="radio" name="payment" value="credit_card" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500" checked>
                        <span class="ml-3 text-sm font-medium text-gray-800">刷卡</span>
                    </label>
                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50 transition-all">
                        <input type="radio" name="payment" value="atm" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-3 text-sm font-medium text-gray-800">ATM 轉帳</span>
                    </label>
                     <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50 transition-all">
                        <input type="radio" name="payment" value="convenience_store" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-3 text-sm font-medium text-gray-800">超商繳費</span>
                    </label>
                </div>
            </div>

            <!-- 總金額計算 -->
            <div class="bg-indigo-50 rounded-lg p-4 mb-6 text-center">
                <p class="text-base text-indigo-800 font-medium">訂單總金額</p>
                <p class="text-3xl font-bold text-indigo-600 my-1">
                    <span id="total-price">960</span> 元
                </p>
            </div>
            
            <!-- 提交按鈕 -->
            <button type="submit" id="submit-button" class="w-full bg-indigo-600 text-white font-semibold py-2.5 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-transform transform hover:scale-105">
                確認送出訂單
            </button>
        </form>
    </div>
    
    <!-- 訊息提示框 -->
    <div id="toast-message" class="bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg">
        <p id="toast-text"></p>
    </div>


    <script type="module">
        // 引入 Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // *** Firebase 初始化 ***
        // 您自己的 Firebase 設定
        const firebaseConfig = {
          apiKey: "AIzaSyBhSNi8nWTzLCsTuWf_QhU10FotQmHzI8o",
          authDomain: "book-preorder-system.firebaseapp.com",
          projectId: "book-preorder-system",
          storageBucket: "book-preorder-system.appspot.com",
          messagingSenderId: "685279838430",
          appId: "1:685279838430:web:44b286ad319d35f93dc24f",
          measurementId: "G-F4FJ2YJ4QD"
        };
        
        let app, db, auth;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            // 匿名登入以取得權限
            await signInAnonymously(auth);

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            db = null; // 初始化失敗時，將 db 設為 null
        }


        // *** 請在這裡設定您的付款連結 ***
        const paymentLinks = {
            credit_card: 'https://your-website.com/credit-card-payment',
            atm: 'https://your-website.com/atm-payment-info',
            convenience_store: 'https://your-website.com/store-payment-code'
        };

        // 取得 HTML 元素
        const form = document.getElementById('preorderForm');
        const quantityInput = document.getElementById('quantity');
        const deliveryOptions = document.querySelectorAll('input[name="delivery"]');
        const totalPriceElement = document.getElementById('total-price');
        const deliveryDetails = document.getElementById('delivery-details');
        const submitButton = document.getElementById('submit-button');
        const toastMessage = document.getElementById('toast-message');
        const toastText = document.getElementById('toast-text');

        const unitPrice = 960;
        const shippingFee = 80;
        let currentTotal = 0;

        function calculateTotal() {
            const quantity = parseInt(quantityInput.value, 10) || 0;
            let total = quantity * unitPrice;
            const selectedDelivery = document.querySelector('input[name="delivery"]:checked').value;
            if (selectedDelivery === 'delivery') {
                total += shippingFee;
            }
            currentTotal = total;
            totalPriceElement.textContent = total.toLocaleString();
        }

        function toggleDeliveryDetails() {
            const selectedDelivery = document.querySelector('input[name="delivery"]:checked').value;
            const required = selectedDelivery === 'delivery';
            
            if (required) {
                deliveryDetails.classList.add('visible');
            } else {
                deliveryDetails.classList.remove('visible');
            }
            
            // 設定宅配欄位是否為必填
            document.getElementById('recipient-name').required = required;
            document.getElementById('recipient-phone').required = required;
            document.getElementById('postal-code').required = required;
            document.getElementById('recipient-address').required = required;
        }

        function showToast(message) {
            toastText.textContent = message;
            toastMessage.classList.add('show');
            setTimeout(() => {
                toastMessage.classList.remove('show');
            }, 3000);
        }

        quantityInput.addEventListener('input', calculateTotal);
        deliveryOptions.forEach(option => option.addEventListener('change', () => {
            calculateTotal();
            toggleDeliveryDetails();
        }));

        document.addEventListener('DOMContentLoaded', () => {
            calculateTotal();
            toggleDeliveryDetails();
            // 如果 Firebase 初始化失敗，在頁面載入時就提示使用者
            if (!db) {
                submitButton.disabled = true;
                submitButton.textContent = '後台連接失敗';
                submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                showToast('無法連接資料庫，請檢查 Firebase 設定。');
            }
        });
        
        form.addEventListener('submit', async function(event) {
            event.preventDefault();

            // 提交時再次檢查 Firebase 連線
            if (!db) {
                showToast('後台連接失敗，無法提交訂單。');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = '訂單處理中...';

            const selectedPaymentMethod = document.querySelector('input[name="payment"]:checked').value;
            const selectedDelivery = document.querySelector('input[name="delivery"]:checked').value;
            
            // 收集訂單資料
            const orderData = {
                customerName: document.getElementById('customer-name').value,
                customerEmail: document.getElementById('customer-email').value,
                quantity: parseInt(quantityInput.value, 10),
                deliveryMethod: selectedDelivery,
                paymentMethod: selectedPaymentMethod,
                totalAmount: currentTotal,
                shippingInfo: null,
                orderStatus: 'pending', // 訂單狀態：待處理
                createdAt: serverTimestamp() // 使用伺服器時間
            };

            if (selectedDelivery === 'delivery') {
                orderData.shippingInfo = {
                    recipientName: document.getElementById('recipient-name').value,
                    recipientPhone: document.getElementById('recipient-phone').value,
                    postalCode: document.getElementById('postal-code').value,
                    address: document.getElementById('recipient-address').value,
                };
            }
            
            try {
                // 將訂單資料存到 Firestore 的 "orders" 集合中
                const docRef = await addDoc(collection(db, `orders`), orderData);
                console.log("訂單已成功儲存，ID: ", docRef.id);
                showToast('訂單已成功送出！即將前往付款頁面...');

                // 成功後跳轉到付款頁面
                setTimeout(() => {
                    const redirectUrl = paymentLinks[selectedPaymentMethod];
                    if (redirectUrl) {
                        window.location.href = redirectUrl;
                    }
                }, 2000);

            } catch (error) {
                console.error("儲存訂單時發生錯誤: ", error);
                showToast('訂單送出失敗，請稍後再試。');
                submitButton.disabled = false;
                submitButton.textContent = '確認送出訂單';
            }
        });
    </script>
</body>
</html>


